<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<title>{{ title }}</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background-color: #f8f9fa; overflow-x: hidden; }
.sidebar { position: fixed; top: 56px; left: 0; height: 100%; width: 240px; background-color: #212529; color: white; transition: all 0.3s ease; overflow-y: auto; z-index: 1000; }
.sidebar.collapsed { width: 70px; }
.sidebar a { color: #adb5bd; display: block; padding: 12px 20px; text-decoration: none; white-space: nowrap; transition: 0.3s; }
.sidebar a:hover, .sidebar a.active { background-color: #495057; color: #fff; }
.sidebar h5 { text-align: center; padding: 10px; }
.sidebar .icon { margin-right: 10px; }
.sidebar.collapsed .text { display: none; }
.content { margin-left: 250px; padding: 100px 20px 20px 20px; transition: all 0.3s ease; }
.content.expanded { margin-left: 80px; }
.toggle-btn { background: none; border: none; color: white; font-size: 22px; cursor: pointer; margin-right: 10px; }
.table th, .table td { vertical-align: middle; }
</style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top shadow-sm">
<div class="container-fluid">
<button class="toggle-btn" id="toggleSidebar">‚ò∞</button>
<a class="navbar-brand fw-bold" href="{{ url_for('painel') }}">NV Sistema</a>
<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
<span class="navbar-toggler-icon"></span>
</button>
<div class="collapse navbar-collapse" id="navbarNav">
<ul class="navbar-nav ms-auto">
<li class="nav-item"><a class="nav-link {% if request.path == '/painel' %}active{% endif %}" href="{{ url_for('painel') }}">In√≠cio</a></li>
<li class="nav-item"><a class="nav-link {% if request.path == '/clientes' %}active{% endif %}" href="{{ url_for('clientes') }}">Clientes</a></li>
<li class="nav-item"><a class="nav-link {% if request.path == '/licencas' %}active{% endif %}" href="{{ url_for('licencas') }}">Licen√ßas</a></li>
<li class="nav-item"><a class="nav-link text-danger" href="{{ url_for('logout') }}">Sair</a></li>
</ul>
</div>
</div>
</nav>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
<h5>Menu</h5>
<a href="{{ url_for('painel') }}" class="{% if request.path == '/painel' %}active{% endif %}"><span class="icon">üìä</span><span class="text">Painel</span></a>
<a href="{{ url_for('faturas') }}" class="{% if request.path == '/faturas' %}active{% endif %}"><span class="icon">üßæ</span><span class="text">Faturas</span></a>
<a href="{{ url_for('licencas') }}" class="{% if request.path == '/licencas' %}active{% endif %}"><span class="icon">üîë</span><span class="text">Licen√ßas</span></a>
<a href="{{ url_for('clientes') }}" class="{% if request.path == '/clientes' %}active{% endif %}"><span class="icon">üë•</span><span class="text">Clientes</span></a>
<a href="{{ url_for('configuracoes') }}" class="{% if request.path == '/configuracoes' %}active{% endif %}"><span class="icon">‚öôÔ∏è</span><span class="text">Configura√ß√µes</span></a>
<a href="{{ url_for('atualizacoes') }}" class="{% if request.path == '/atualizacoes' %}active{% endif %}"><span class="icon">üì¶</span><span class="text">Atualiza√ß√µes</span></a>
</div>

<!-- Conte√∫do principal -->
<div class="content" id="content">
<h3 class="text-center mb-4 mt-3">{{ title or 'Faturas' }}</h3>

<!-- Flash messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<!-- Formul√°rio de agendamento -->
<div class="card mb-4 shadow-sm">
  <div class="card-header bg-dark text-white">Agendar Nova Fatura</div>
  <div class="card-body">
    <form action="{{ url_for('agendar_fatura') }}" method="POST" class="row g-3">
      <div class="col-md-4">
        <label for="cliente_id" class="form-label">Cliente</label>
        <select id="cliente_id" name="cliente_id" class="form-select" required>
          <option value="">Selecione...</option>
          {% for c in clientes %}
            <option value="{{ c[0] }}" data-email="{{ c[2] }}">{{ c[1] }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label for="email_cliente" class="form-label">Email do Cliente</label>
        <input type="email" id="email_cliente" name="email_cliente" class="form-control" placeholder="Email do cliente">
      </div>
      <div class="col-md-2">
        <label for="valor" class="form-label">Valor (MZN)</label>
        <input type="number" step="0.01" id="valor" name="valor" class="form-control" placeholder="0.00" required>
      </div>
      <div class="col-md-2">
        <label for="dia_emissao" class="form-label">Data de Emiss√£o</label>
        <input type="date" id="dia_emissao" name="dia_emissao" class="form-control" required>
      </div>
      <div class="col-12 text-end mt-3">
        <button type="submit" class="btn btn-success">Agendar Fatura</button>
      </div>
    </form>
  </div>
</div>

<!-- Tabela de faturas agendadas -->
<div class="card shadow-sm">
  <div class="card-header bg-dark text-white">Faturas Agendadas</div>
  <div class="card-body">
    <table class="table table-striped table-hover align-middle">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>Cliente</th>
          <th>Email</th>
          <th>Valor (MZN)</th>
          <th>Data Emiss√£o</th>
          <th>Pr√≥ximo Envio</th>
          <th>Status</th>
          <th class="text-center">A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        {% for f in faturas %}
        <tr>
          <td>{{ f[0] }}</td>
          <td>{{ f[2] }}</td>
          <td>{{ f[3] }}</td>
          <td>{{ f[4] }}</td>
          <td>{{ f[5].strftime("%Y-%m-%d") if f[5] else "" }}</td>
          <td>{{ f[6].strftime("%Y-%m-%d %H:%M") if f[6] else "" }}</td>
          <td>{% if f[7] %}<span class="badge bg-success">Ativa</span>{% else %}<span class="badge bg-secondary">Cancelada</span>{% endif %}</td>
          <td class="text-center">
            {% if f[7] %}
            <form action="{{ url_for('cancelar_fatura', fatura_id=f[0]) }}" method="POST" onsubmit="return confirm('Deseja cancelar esta fatura?');">
              <button class="btn btn-sm btn-danger">Cancelar</button>
            </form>
            {% else %}
              -
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Toggle sidebar
const toggleBtn = document.getElementById("toggleSidebar");
const sidebar = document.getElementById("sidebar");
const content = document.getElementById("content");

if(localStorage.getItem("sidebarCollapsed") === "true") {
    sidebar.classList.add("collapsed");
    content.classList.add("expanded");
}

toggleBtn.addEventListener("click", () => {
    sidebar.classList.toggle("collapsed");
    content.classList.toggle("expanded");
    localStorage.setItem("sidebarCollapsed", sidebar.classList.contains("collapsed"));
});

// Auto preencher email ao selecionar cliente
const clienteSelect = document.getElementById("cliente_id");
const emailInput = document.getElementById("email_cliente");

clienteSelect.addEventListener("change", function() {
    const selected = clienteSelect.selectedOptions[0];
    emailInput.value = selected.dataset.email || "";
});
</script>

</body>
</html>
