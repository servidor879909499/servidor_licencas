<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<title>{{ title }}</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background-color: #f8f9fa; overflow-x: hidden; }
.sidebar { position: fixed; top: 56px; left: 0; height: 100%; width: 240px; background-color: #212529; color: white; transition: all 0.3s ease; overflow-y: auto; z-index: 1000; }
.sidebar.collapsed { width: 70px; }
.sidebar a { color: #adb5bd; display: block; padding: 12px 20px; text-decoration: none; white-space: nowrap; transition: 0.3s; }
.sidebar a:hover, .sidebar a.active { background-color: #495057; color: #fff; }
.sidebar h5 { text-align: center; padding: 10px; }
.sidebar .icon { margin-right: 10px; }
.sidebar.collapsed .text { display: none; }
.content { margin-left: 250px; padding: 100px 20px 20px 20px; transition: all 0.3s ease; }
.content.expanded { margin-left: 80px; }
.table th, .table td { vertical-align: middle; }
.toggle-btn { background: none; border: none; color: white; font-size: 22px; cursor: pointer; margin-right: 10px; }
</style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top shadow-sm">
<div class="container-fluid">
<button class="toggle-btn" id="toggleSidebar">‚ò∞</button>
<a class="navbar-brand fw-bold" href="{{ url_for('painel') }}">NV Sistema</a>
<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
<span class="navbar-toggler-icon"></span>
</button>
<div class="collapse navbar-collapse" id="navbarNav">
<ul class="navbar-nav ms-auto">
<li class="nav-item"><a class="nav-link {% if request.path == '/painel' %}active{% endif %}" href="{{ url_for('painel') }}">In√≠cio</a></li>
<li class="nav-item"><a class="nav-link {% if request.path == '/clientes' %}active{% endif %}" href="{{ url_for('clientes') }}">Clientes</a></li>
<li class="nav-item"><a class="nav-link {% if request.path == '/licencas' %}active{% endif %}" href="{{ url_for('licencas') }}">Licen√ßas</a></li>
<li class="nav-item"><a class="nav-link text-danger" href="{{ url_for('logout') }}">Sair</a></li>
</ul>
</div>
</div>
</nav>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
<h5>Menu</h5>
<a href="{{ url_for('painel') }}" class="{% if request.path == '/painel' %}active{% endif %}"><span class="icon">üìä</span><span class="text">Painel</span></a>
<a href="{{ url_for('faturas') }}" class="{% if request.path == '/faturas' %}active{% endif %}"><span class="icon">üßæ</span><span class="text">Faturas</span></a>
<a href="{{ url_for('licencas') }}" class="{% if request.path == '/licencas' %}active{% endif %}"><span class="icon">üîë</span><span class="text">Licen√ßas</span></a>
<a href="{{ url_for('clientes') }}" class="{% if request.path == '/clientes' %}active{% endif %}"><span class="icon">üë•</span><span class="text">Clientes</span></a>
<a href="{{ url_for('configuracoes') }}" class="{% if request.path == '/configuracoes' %}active{% endif %}"><span class="icon">‚öôÔ∏è</span><span class="text">Configura√ß√µes</span></a>
<a href="{{ url_for('atualizacoes') }}" class="{% if request.path == '/atualizacoes' %}active{% endif %}"><span class="icon">üì¶</span><span class="text">Atualiza√ß√µes</span></a>
</div>

<!-- Conte√∫do principal -->
<div class="content" id="content">
<h3 class="text-center mb-4 mt-3">{{ title }}</h3>

<!-- Flash messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<table class="table table-striped table-hover shadow-sm align-middle">
<thead class="table-dark">
<tr>
<th>Empresa</th><th>M√°quina ID</th><th>Chave</th><th>Data In√≠cio</th><th>Data Fim</th><th>Dias</th><th>Status</th><th>√öltima Sync</th><th class="text-center">A√ß√µes</th>
</tr>
</thead>
<tbody>
{% for c in clientes %}
<tr>
<td>{{ c[1] }}</td>
<td>{{ c[2] }}</td>
<td>{{ c[3] }}</td>
<td>{{ c[4].strftime("%Y-%m-%d %H:%M:%S") if c[4] else "" }}</td>
<td>{{ c[8].strftime("%Y-%m-%d %H:%M:%S") if c[8] else "" }}</td>
<td>{{ c[5] }}</td>
<td>{% if c[6] == 'ativo' %}<span class="badge bg-success">Ativo</span>{% else %}<span class="badge bg-danger">Bloqueado</span>{% endif %}</td>
<td>{{ c[7].strftime("%Y-%m-%d %H:%M:%S") if c[7] else "" }}</td>
<td class="text-center">
<div class="d-flex justify-content-center gap-1 flex-wrap">

  <!-- Prolongar -->
  <form action="{{ url_for('prolongar', cliente_id=c[0]) }}" method="POST" class="d-inline">
    <input type="number" name="dias" placeholder="Dias" class="form-control form-control-sm mb-1" required>
    <button class="btn btn-sm btn-primary w-100">Prolongar</button>
  </form>

  <!-- Diminuir -->
  <form action="{{ url_for('diminuir', cliente_id=c[0]) }}" method="POST" class="d-inline">
    <input type="number" name="dias" placeholder="Dias" class="form-control form-control-sm mb-1" required>
    <button class="btn btn-sm btn-warning w-100 text-dark">Diminuir</button>
  </form>

  <!-- Bloquear -->
  <form action="{{ url_for('bloquear', cliente_id=c[0]) }}" method="POST" class="d-inline">
    <button class="btn btn-sm btn-secondary w-100">Bloquear</button>
  </form>

  <!-- Emitir Fatura -->
  <button class="btn btn-sm btn-info w-100" data-bs-toggle="modal" data-bs-target="#faturaModal{{ c[0] }}">Emitir Fatura</button>

  <!-- Remover -->
  <form action="{{ url_for('remover', cliente_id=c[0]) }}" method="POST" class="d-inline"
        onsubmit="return confirm('Tem certeza que deseja remover esta empresa? Esta a√ß√£o n√£o pode ser desfeita.');">
    <button class="btn btn-sm btn-danger w-100">Remover</button>
  </form>

</div>
</td>
</tr>

<!-- Modal de Fatura -->
<div class="modal fade" id="faturaModal{{ c[0] }}" tabindex="-1" aria-labelledby="faturaModalLabel{{ c[0] }}" aria-hidden="true">
  <div class="modal-dialog">
    <form action="{{ url_for('emitir_fatura', cliente_id=c[0]) }}" method="POST">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="faturaModalLabel{{ c[0] }}">Emitir Fatura - {{ c[1] }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label>Cliente</label>
            <input type="text" class="form-control" value="{{ c[1] }}" readonly>
          </div>
          <div class="mb-3">
            <label>Email</label>
            <input type="email" class="form-control" name="email_cliente" value="{{ c[9] if c|length > 9 else '' }}" required>
          </div>
          <div class="mb-3">
            <label>Valor Mensal (MZN)</label>
            <input type="number" class="form-control" name="valor_mensal" required>
          </div>
          <div class="mb-3">
            <label>Data de Emiss√£o</label>
            <input type="date" class="form-control" name="data_emissao" required>
          </div>
          <div class="mb-3">
            <label>Data de Envio</label>
            <input type="date" class="form-control" name="data_envio" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar & Enviar</button>
        </div>
      </div>
    </form>
  </div>
</div>

{% endfor %}
</tbody>
</table>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const toggleBtn = document.getElementById("toggleSidebar");
const sidebar = document.getElementById("sidebar");
const content = document.getElementById("content");

// Lembrar estado do sidebar
if(localStorage.getItem("sidebarCollapsed") === "true") {
    sidebar.classList.add("collapsed");
    content.classList.add("expanded");
}

toggleBtn.addEventListener("click", () => {
    sidebar.classList.toggle("collapsed");
    content.classList.toggle("expanded");
    localStorage.setItem("sidebarCollapsed", sidebar.classList.contains("collapsed"));
});
</script>

</body>
</html>
